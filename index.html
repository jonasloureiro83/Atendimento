<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Atendente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 to-purple-100 min-h-screen font-sans text-gray-800 p-4 sm:p-8 flex flex-col items-center">

    <div id="root" class="max-w-5xl w-full bg-white rounded-3xl shadow-2xl p-6 sm:p-10 text-center">
        <!-- O conteúdo da aplicação será renderizado aqui -->
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, updateDoc, onSnapshot, runTransaction, getDocs, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let attendantName = localStorage.getItem('attendantName') || '';
        let loading = true;
        let ttsLoading = false;
        let userId = null;
        let allTickets = [];
        let normalTickets = [];
        let preferentialTickets = [];
        let currentTicket = null;
        let avgNormalWaitTime = '0 min e 0 seg';
        let avgPreferentialWaitTime = '0 min e 0 seg';

        const ticketAnimationClasses = 'transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-lg';

        function base64ToArrayBuffer(base64) {
          const binaryString = atob(base64);
          const len = binaryString.length;
          const bytes = new Uint8Array(len);
          for (let i = 0; i < len; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }
          return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
          const header = new ArrayBuffer(44);
          const view = new DataView(header);
          view.setUint32(0, 0x52494646, false);
          view.setUint32(4, 36 + pcmData.length * 2, true);
          view.setUint32(8, 0x57415645, false);
          view.setUint32(12, 0x666d7420, false);
          view.setUint32(16, 16, true);
          view.setUint16(20, 1, true);
          view.setUint16(22, 1, true);
          view.setUint32(24, sampleRate, true);
          view.setUint32(28, sampleRate * 2, true);
          view.setUint16(32, 2, true);
          view.setUint16(34, 16, true);
          view.setUint32(36, 0x64617461, false);
          view.setUint32(40, pcmData.length * 2, true);
          const wavData = new Uint8Array(44 + pcmData.length * 2);
          wavData.set(new Uint8Array(header), 0);
          wavData.set(new Uint8Array(pcmData.buffer), 44);
          return new Blob([wavData], { type: 'audio/wav' });
        }

        const getTicketStatusClasses = (status) => {
            switch (status) {
              case 'waiting': return 'bg-blue-200 text-blue-800 border-blue-300';
              case 'called': return 'bg-yellow-200 text-yellow-800 border-yellow-300 animate-pulse';
              case 'served': return 'bg-green-200 text-green-800 border-green-300 opacity-70';
              case 'absent': return 'bg-gray-400 text-gray-800 border-gray-500 opacity-70';
              default: return 'bg-gray-100 text-gray-700 border-gray-200';
            }
        };

        const getTicketStatusText = (status) => {
            switch (status) {
              case 'waiting': return 'Aguardando';
              case 'called': return 'Em Atendimento';
              case 'served': return 'Finalizado';
              case 'absent': return 'Ausente';
              default: return 'Desconhecido';
            }
        };

        const calculateAvgWaitTime = (tickets) => {
          if (tickets.length === 0) return '0 min e 0 seg';
          const now = new Date();
          const totalWaitTime = tickets.reduce((sum, ticket) => {
            const ticketTime = new Date(ticket.timestamp);
            return sum + (now - ticketTime);
          }, 0);
          const avgWaitTimeMs = totalWaitTime / tickets.length;
          const minutes = Math.floor(avgWaitTimeMs / 60000);
          const seconds = Math.floor((avgWaitTimeMs % 60000) / 1000);
          return `${minutes} min e ${seconds} seg`;
        };

        const updateUI = () => {
            const root = document.getElementById('root');
            let lastTicketHtml = '';
            if (currentTicket) {
              const ticketTypeClass = currentTicket.type === 'preferential' ? 'text-red-600 border-red-400' : 'text-indigo-600 border-indigo-400';
              lastTicketHtml = `
                <p class="text-xl font-medium text-gray-700 mb-2">
                    ${currentTicket.customerName ? `Atendendo: ${currentTicket.customerName}` : 'Sem nome'}
                </p>
                <p class="text-xl font-medium text-gray-700 mb-2">Chamado por: <span class="font-bold text-indigo-600">${currentTicket.calledBy}</span></p>
                <div class="bg-white p-6 rounded-full w-32 h-32 flex flex-col items-center justify-center text-5xl font-black shadow-xl border-4 ${ticketTypeClass}">
                    <span class="text-xl -mt-2">${currentTicket.type === 'preferential' ? 'Pref.' : 'Normal'}</span>
                    <span class="text-5xl -mt-1">${currentTicket.ticketNumber}</span>
                </div>
              `;
            } else {
              lastTicketHtml = `<p class="text-gray-500 text-xl">Nenhuma senha chamada</p>`;
            }

            const preferentialTicketsHtml = preferentialTickets.length > 0 ?
                preferentialTickets.map(ticket => `
                    <div class="p-3 text-center rounded-lg shadow-md ${getTicketStatusClasses(ticket.status)} ${ticketAnimationClasses}">
                        <span class="text-2xl font-extrabold">${ticket.ticketNumber}</span>
                    </div>
                `).join('') :
                `<p class="col-span-full text-center text-gray-500 py-4">A fila preferencial está vazia.</p>`;

            const normalTicketsHtml = normalTickets.length > 0 ?
                normalTickets.map(ticket => `
                    <div class="p-3 text-center rounded-lg shadow-md ${getTicketStatusClasses(ticket.status)} ${ticketAnimationClasses}">
                        <span class="text-2xl font-extrabold">${ticket.ticketNumber}</span>
                    </div>
                `).join('') :
                `<p class="col-span-full text-center text-gray-500 py-4">A fila normal está vazia.</p>`;
            
            const allTicketsHtml = allTickets.map(ticket => `
                <tr class="border-b border-gray-200 hover:bg-gray-100">
                    <td class="py-3 px-6 text-left whitespace-nowrap">
                        <span class="font-bold text-lg">${ticket.ticketNumber}</span>
                    </td>
                    <td class="py-3 px-6 text-left">
                        <span class="py-1 px-3 rounded-full text-xs font-semibold ${ticket.type === 'preferential' ? 'bg-red-200 text-red-600' : 'bg-indigo-200 text-indigo-600'}">
                            ${ticket.type === 'preferential' ? 'Preferencial' : 'Normal'}
                        </span>
                    </td>
                    <td class="py-3 px-6 text-left">
                        <span class="py-1 px-3 rounded-full text-xs font-semibold ${getTicketStatusClasses(ticket.status)}">
                            ${getTicketStatusText(ticket.status)}
                        </span>
                    </td>
                    <td class="py-3 px-6 text-left">
                        <span>${ticket.customerName || '-'}</span>
                    </td>
                    <td class="py-3 px-6 text-left">
                        <span>${ticket.calledBy || '-'}</span>
                    </td>
                    <td class="py-3 px-6 text-left">
                        ${ticket.status === 'waiting' ? `<button class="bg-orange-400 text-white font-bold py-1 px-3 rounded-xl text-xs hover:bg-orange-500 transition duration-300 mark-absent-btn" data-ticket-id="${ticket.id}">Ausente</button>` : ''}
                    </td>
                </tr>
            `).join('');

            root.innerHTML = `
                <h1 class="text-4xl sm:text-5xl font-extrabold text-indigo-700 mb-2">Painel do Atendente</h1>
                <p class="text-lg sm:text-xl text-gray-600 mb-8">
                  Gerenciamento de fila de espera com senhas.
                </p>
                ${loading ? `
                  <div class="flex justify-center items-center h-24">
                      <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-500"></div>
                  </div>
                ` : `
                  <div class="mb-8">
                    <label htmlFor="attendant-name" class="block text-sm font-medium text-gray-700 mb-2">
                      Seu nome de Atendente:
                    </label>
                    <input
                      id="attendant-name"
                      type="text"
                      value="${attendantName}"
                      class="w-full sm:w-1/2 p-3 text-center border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500"
                      placeholder="Ex: João"
                    />
                  </div>
                  <div class="flex flex-col sm:flex-row gap-4 mb-10 justify-center">
                    <button id="generate-normal" class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-indigo-700 transition duration-300 transform hover:scale-105 active:scale-95">
                      Gerar Senha Normal
                    </button>
                    <button id="generate-preferential" class="bg-red-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-red-700 transition duration-300 transform hover:scale-105 active:scale-95">
                      Gerar Senha Preferencial
                    </button>
                    <button id="call-next" class="bg-purple-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition duration-300 transform ${ttsLoading ? 'opacity-50 cursor-not-allowed' : 'hover:bg-purple-700 hover:scale-105 active:scale-95'}">
                      Chamar Próxima Senha
                    </button>
                    <button id="reset" class="bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-gray-500 transition duration-300 transform hover:scale-105 active:scale-95">
                      Resetar Filas
                    </button>
                  </div>
                  <div class="bg-indigo-100 p-6 rounded-2xl shadow-inner mb-8">
                    <h2 class="text-2xl font-bold text-indigo-800 mb-2">Senha Atual</h2>
                    <div class="flex flex-col items-center justify-center h-32">
                      ${lastTicketHtml}
                    </div>
                  </div>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-gray-50 p-6 rounded-2xl shadow-inner">
                      <h2 class="text-2xl font-bold text-gray-800 mb-2">Fila Preferencial (${preferentialTickets.length})</h2>
                      <p class="text-sm font-medium text-gray-600 mb-4">
                        Tempo médio de espera: <span class="font-bold text-red-500">${avgPreferentialWaitTime}</span>
                      </p>
                      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 max-h-64 overflow-y-auto p-2">
                        ${preferentialTicketsHtml}
                      </div>
                    </div>
                    <div class="bg-gray-50 p-6 rounded-2xl shadow-inner">
                      <h2 class="text-2xl font-bold text-gray-800 mb-2">Fila Normal (${normalTickets.length})</h2>
                      <p class="text-sm font-medium text-gray-600 mb-4">
                        Tempo médio de espera: <span class="font-bold text-indigo-500">${avgNormalWaitTime}</span>
                      </p>
                      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 max-h-64 overflow-y-auto p-2">
                        ${normalTicketsHtml}
                      </div>
                    </div>
                  </div>
                  <div class="mt-10 p-6 bg-white rounded-2xl shadow-inner">
                      <h2 class="text-3xl font-bold text-indigo-700 mb-6">Tabela de Atendimentos</h2>
                      <div class="overflow-x-auto">
                          <table class="min-w-full bg-white rounded-xl shadow-md">
                              <thead>
                                  <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                                      <th class="py-3 px-6 text-left">Número</th>
                                      <th class="py-3 px-6 text-left">Tipo</th>
                                      <th class="py-3 px-6 text-left">Status</th>
                                      <th class="py-3 px-6 text-left">Nome do Cliente</th>
                                      <th class="py-3 px-6 text-left">Chamado Por</th>
                                      <th class="py-3 px-6 text-left">Ações</th>
                                  </tr>
                              </thead>
                              <tbody class="text-gray-600 text-sm font-light">
                                  ${allTicketsHtml}
                              </tbody>
                          </table>
                      </div>
                  </div>
                `}
            `;

            document.getElementById('attendant-name').addEventListener('input', (e) => {
                attendantName = e.target.value;
                localStorage.setItem('attendantName', attendantName);
            });
            document.getElementById('generate-normal').addEventListener('click', () => handleGenerateTicket('normal'));
            document.getElementById('generate-preferential').addEventListener('click', () => handleGenerateTicket('preferential'));
            document.getElementById('call-next').addEventListener('click', handleCallNext);
            document.getElementById('reset').addEventListener('click', handleReset);
            document.querySelectorAll('.mark-absent-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const ticketId = e.target.dataset.ticketId;
                    handleMarkAbsent(ticketId);
                });
            });
        };

        const handleGenerateTicket = async (type, customerName = null) => {
            loading = true;
            updateUI();
            try {
                const publicTicketsPath = `artifacts/${appId}/public/data/tickets`;
                const counterRef = doc(db, publicTicketsPath, `ticket-counter-${type}`);
                await runTransaction(db, async (transaction) => {
                    const counterDoc = await transaction.get(counterRef);
                    let nextTicketNumber = 1;
                    if (counterDoc.exists()) {
                        nextTicketNumber = counterDoc.data().currentNumber + 1;
                    }
                    const newTicketRef = doc(collection(db, publicTicketsPath));
                    transaction.set(newTicketRef, {
                        ticketNumber: nextTicketNumber,
                        type: type,
                        status: 'waiting',
                        timestamp: new Date().toISOString(),
                        userId: userId,
                        calledBy: '',
                        customerName: customerName,
                    });
                    transaction.set(counterRef, { currentNumber: nextTicketNumber });
                });
            } catch (error) {
                console.error("Erro ao gerar a senha:", error);
            } finally {
                loading = false;
                updateUI();
            }
        };

        const playAudio = async (textToSpeak) => {
            ttsLoading = true;
            updateUI();
            let attempts = 0;
            const maxAttempts = 5;
            let delay = 1000;
            const ttsPayload = {
              contents: [{ parts: [{ text: textToSpeak }] }],
              generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } } },
              model: "gemini-2.5-flash-preview-tts"
            };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
            while (attempts < maxAttempts) {
              try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(ttsPayload) });
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;
                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                  const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                  const pcmData = base64ToArrayBuffer(audioData);
                  const pcm16 = new Int16Array(pcmData);
                  const wavBlob = pcmToWav(pcm16, sampleRate);
                  const audioUrl = URL.createObjectURL(wavBlob);
                  const audio = new Audio(audioUrl);
                  await audio.play();
                  audio.onended = () => { ttsLoading = false; updateUI(); };
                  return;
                } else throw new Error("Estrutura de resposta de áudio inválida.");
              } catch (error) {
                attempts++;
                if (attempts < maxAttempts) {
                  console.warn(`Tentativa ${attempts} falhou. Tentando novamente em ${delay / 1000}s...`);
                  await new Promise(res => setTimeout(res, delay));
                  delay *= 2;
                } else {
                  console.error("Erro fatal ao gerar ou reproduzir áudio:", error);
                  ttsLoading = false;
                  updateUI();
                }
              }
            }
        };

        const handleCallNext = async () => {
            if (!db || ttsLoading) return;
            loading = true;
            updateUI();
            try {
              let nextTicket;
              if (preferentialTickets.length > 0) nextTicket = preferentialTickets[0];
              else if (normalTickets.length > 0) nextTicket = normalTickets[0];
              if (nextTicket) {
                if (currentTicket) {
                  const docRef = doc(db, `artifacts/${appId}/public/data/tickets`, currentTicket.id);
                  await updateDoc(docRef, { status: 'served' });
                }
                const docRef = doc(db, `artifacts/${appId}/public/data/tickets`, nextTicket.id);
                const calledByName = attendantName || 'Atendente Anônimo';
                await updateDoc(docRef, { status: 'called', calledBy: calledByName });
                const ticketType = nextTicket.type === 'preferential' ? 'preferencial' : 'normal';
                let message = '';
                if (nextTicket.customerName) message += `${nextTicket.customerName}, `;
                message += `senha ${ticketType} ${nextTicket.ticketNumber}, por favor, dirija-se ao atendente ${calledByName}.`;
                playAudio(message);
              }
            } catch (error) {
              console.error("Erro ao chamar a próxima senha:", error);
            } finally {
              loading = false;
              updateUI();
            }
        };

        const handleMarkAbsent = async (ticketId) => {
            if (!db) return;
            loading = true;
            updateUI();
            try {
              const docRef = doc(db, `artifacts/${appId}/public/data/tickets`, ticketId);
              await updateDoc(docRef, { status: 'absent' });
            } catch (error) {
              console.error("Erro ao marcar senha como ausente:", error);
            } finally {
              loading = false;
              updateUI();
            }
        };

        const handleReset = async () => {
            if (!db) return;
            loading = true;
            updateUI();
            try {
              const publicTicketsPath = `artifacts/${appId}/public/data/tickets`;
              const ticketsCollectionRef = collection(db, publicTicketsPath);
              const counterNormalRef = doc(db, publicTicketsPath, 'ticket-counter-normal');
              const counterPreferentialRef = doc(db, publicTicketsPath, 'ticket-counter-preferential');
              const querySnapshot = await getDocs(ticketsCollectionRef);
              const batch = [];
              querySnapshot.forEach((document) => { batch.push(deleteDoc(document.ref)); });
              await Promise.all(batch);
              await setDoc(counterNormalRef, { currentNumber: 0 });
              await setDoc(counterPreferentialRef, { currentNumber: 0 });
            } catch (error) {
              console.error("Erro ao resetar as filas:", error);
            } finally {
              loading = false;
              updateUI();
            }
        };

        const main = async () => {
          try {
            if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
            else await signInAnonymously(auth);
            userId = auth.currentUser?.uid || 'anonymous';
            
            const publicTicketsPath = `artifacts/${appId}/public/data/tickets`;
            const ticketsCollectionRef = collection(db, publicTicketsPath);
            onSnapshot(ticketsCollectionRef, (snapshot) => {
              const allDocs = [];
              let currentTicketData = null;
              snapshot.docs.forEach(doc => {
                const data = { id: doc.id, ...doc.data() };
                if (data.status === 'called') {
                  if (!currentTicketData || data.timestamp > currentTicketData.timestamp) currentTicketData = data;
                }
                if (data.ticketNumber && data.type) allDocs.push(data);
              });
              allDocs.sort((a, b) => a.ticketNumber - b.ticketNumber);
              allTickets = allDocs;
              normalTickets = allDocs.filter(t => t.type === 'normal' && t.status === 'waiting').sort((a, b) => a.timestamp.localeCompare(b.timestamp));
              preferentialTickets = allDocs.filter(t => t.type === 'preferential' && t.status === 'waiting').sort((a, b) => a.timestamp.localeCompare(b.timestamp));
              avgNormalWaitTime = calculateAvgWaitTime(normalTickets);
              avgPreferentialWaitTime = calculateAvgWaitTime(preferentialTickets);
              currentTicket = currentTicketData;
              loading = false;
              updateUI();
            }, (error) => {
              console.error("Erro ao carregar as senhas:", error);
              loading = false;
              updateUI();
            });
          } catch (error) {
            console.error("Erro na inicialização:", error);
            loading = false;
            updateUI();
          }
        };
        main();
    </script>
</body>
</html>
