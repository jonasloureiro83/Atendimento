<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Cliente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-500 to-indigo-600 min-h-screen font-sans text-white p-4 sm:p-8 flex flex-col items-center justify-center">

    <div id="root" class="max-w-md w-full bg-white bg-opacity-90 rounded-3xl shadow-2xl p-6 sm:p-8 text-center text-gray-800">
        <!-- O conteúdo da aplicação será renderizado aqui -->
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, runTransaction, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Renderiza a aplicação
        renderApp();

        async function renderApp() {
            let customerName = '';
            let lastTicket = null;
            let loading = true;
            let userId = null;

            const updateUI = () => {
                const root = document.getElementById('root');
                root.innerHTML = ''; // Limpa o conteúdo anterior

                // Lógica de carregamento
                if (loading) {
                    root.innerHTML = `
                        <h1 class="text-4xl sm:text-5xl font-extrabold text-indigo-700 mb-2">Painel do Cliente</h1>
                        <p class="text-lg sm:text-xl text-gray-600 mb-8">
                            Por favor, insira seu nome para gerar uma senha.
                        </p>
                        <div class="flex justify-center items-center h-24">
                            <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-500"></div>
                        </div>
                    `;
                    return;
                }

                // Conteúdo principal
                let lastTicketHtml = '';
                if (lastTicket) {
                    const ticketTypeClass = lastTicket.type === 'preferential' ? 'text-red-600 bg-red-100 border-red-300' : 'text-indigo-600 bg-indigo-100 border-indigo-300';
                    lastTicketHtml = `
                        <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
                            <h3 class="text-xl font-bold text-gray-700 mb-2">Sua Senha</h3>
                            <p class="text-lg text-gray-600">
                                ${lastTicket.customerName}, sua senha é:
                            </p>
                            <div class="p-4 mt-2 inline-block rounded-xl font-black text-4xl shadow-md ${ticketTypeClass}">
                                ${lastTicket.ticketNumber}
                            </div>
                            <p class="mt-2 text-sm text-gray-500">
                                Por favor, aguarde seu nome e número serem chamados.
                            </p>
                        </div>
                    `;
                }

                root.innerHTML = `
                    <h1 class="text-4xl sm:text-5xl font-extrabold text-indigo-700 mb-2">Painel do Cliente</h1>
                    <p class="text-lg sm:text-xl text-gray-600 mb-8">
                        Por favor, insira seu nome para gerar uma senha.
                    </p>
                    
                    <div class="mb-6">
                        <label htmlFor="customer-name" class="block text-sm font-medium text-gray-700 mb-2">
                            Seu nome:
                        </label>
                        <input
                            id="customer-name"
                            type="text"
                            value="${customerName}"
                            class="w-full p-3 text-center border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            placeholder="Ex: Maria"
                        />
                    </div>
                    
                    <div class="flex flex-col gap-4 mb-8">
                        <button id="normal-button" class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-indigo-700 transition duration-300 transform hover:scale-105 active:scale-95">
                            Gerar Senha Normal
                        </button>
                        <button id="preferential-button" class="bg-red-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-red-700 transition duration-300 transform hover:scale-105 active:scale-95">
                            Gerar Senha Preferencial
                        </button>
                    </div>
                    
                    ${lastTicketHtml}
                `;

                // Adiciona listeners para os eventos
                document.getElementById('customer-name').addEventListener('input', (e) => {
                    customerName = e.target.value;
                    // Atualiza a UI para refletir a mudança
                    const inputElement = document.getElementById('customer-name');
                    if (inputElement) {
                        inputElement.value = customerName;
                    }
                });

                document.getElementById('normal-button').addEventListener('click', () => handleGenerateTicket('normal'));
                document.getElementById('preferential-button').addEventListener('click', () => handleGenerateTicket('preferential'));
            };

            const handleGenerateTicket = async (type) => {
                loading = true;
                updateUI();
                try {
                    const publicTicketsPath = `artifacts/${appId}/public/data/tickets`;
                    const counterRef = doc(db, publicTicketsPath, `ticket-counter-${type}`);

                    await runTransaction(db, async (transaction) => {
                        const counterDoc = await transaction.get(counterRef);
                        let nextTicketNumber = 1;

                        if (counterDoc.exists()) {
                            nextTicketNumber = counterDoc.data().currentNumber + 1;
                        }

                        const newTicketRef = doc(collection(db, publicTicketsPath));
                        transaction.set(newTicketRef, {
                            ticketNumber: nextTicketNumber,
                            type: type,
                            status: 'waiting',
                            timestamp: new Date().toISOString(),
                            userId: userId,
                            calledBy: '',
                            customerName: customerName || 'Anônimo',
                        });

                        transaction.set(counterRef, { currentNumber: nextTicketNumber });
                        lastTicket = {
                            ticketNumber: nextTicketNumber,
                            type: type,
                            customerName: customerName || 'Anônimo'
                        };
                    });

                    setTimeout(() => {
                        customerName = '';
                        lastTicket = null;
                        updateUI();
                    }, 5000);

                } catch (error) {
                    console.error("Erro ao gerar a senha:", error);
                } finally {
                    loading = false;
                    updateUI();
                }
            };
            
            // Autentica o usuário no início
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser?.uid || 'anonymous';
            } catch (error) {
                console.error("Erro ao inicializar o Firebase:", error);
            } finally {
                loading = false;
                updateUI();
            }
        }
    </script>
</body>
</html>
